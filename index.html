<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3D Gaussian Splat Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
        background-color: #000; /* Default background for Three.js */
        overflow: hidden; /* Prevent scrollbars */
    }
    #renderer-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0; /* Behind the UI panel */
    }
    #container {
        position: relative; /* Needed for z-index stacking */
        z-index: 1; /* Above the renderer */
    }
    /* Minimal styles for loading icon if needed before Tailwind loads or for custom animations */
    .loading-icon {
        width: 35px;
        margin: 10px auto;
        background: #324d70; /* Tailwind bg-blue-800 */
        aspect-ratio: 1;
        border-radius: 50%;
        --_m:
            conic-gradient(#0000,#000),
            linear-gradient(#000 0 0) content-box;
        -webkit-mask: var(--_m);
            mask: var(--_m);
        -webkit-mask-composite: source-out;
            mask-composite: subtract;
        box-sizing: border-box;
        animation: ply-load 1s linear infinite;
    }

    @keyframes ply-load {
        to{transform: rotate(1turn)}
    }
    .file-ext, .file-ext-small {
        border: 1px solid #bababa; /* Tailwind border-gray-300 */
        border-radius: 3px; /* Tailwind rounded-sm */
        background-color: #e6e6e6; /* Tailwind bg-gray-200 */
        padding: 1px 4px;
        margin: 0 2px;
        font-size: 0.875rem; /* Tailwind text-sm */
        display: inline-block;
    }
    .file-ext-small {
         background-color: #dfdfdf; /* Tailwind bg-gray-100 */
         padding-bottom: 1px;
    }
  </style>
  <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "gaussian-splats-3d": "./lib/gaussian-splats-3d.module.js"
        }
    }
  </script>
</head>

<body class="h-screen m-0 font-sans text-base">
  <!-- UI Panel -->
  <div id="container" class="flex justify-center items-center h-full">
    <div id ="view-panel" class="p-5 text-gray-900 rounded-lg border border-gray-300 bg-gray-100 w-96 text-center shadow-lg">
        <div class="text-lg font-bold text-gray-700 mb-4 block">View a .ply, .ksplat, or .splat file</div>
        <table class="w-full text-left mb-4">
            <tbody>
                <tr>
                    <td colspan="2" class="text-center py-2">
                        <label for="viewFile" class="inline-block">
                            <span class="text-blue-800 border border-blue-300 bg-blue-100 hover:bg-blue-200 hover:border-blue-500 hover:text-blue-900 py-1 px-3 rounded-md shadow-md cursor-pointer mx-1">Choose file</span>
                            <input type="file" id="viewFile" class="hidden" onchange="window.onFileChange(this, 'viewFileName')">
                        </label>
                        <span id="viewFileName" class="pl-3 text-gray-700"></span>
                    </td>
                </tr>
                <tr>
                    <td class="w-2/5 text-right pr-2 py-1">Minimum alpha:</td>
                    <td class="w-3/5 text-left py-1">
                        <input id="alphaRemovalThresholdView" type="text" class="border border-gray-400 bg-white p-1 rounded-md w-14" value="1">
                        <span class="text-gray-500 text-xs">(1-255)</span>
                    </td>
                </tr>
                <tr>
                    <td class="w-2/5 text-right pr-2 py-1">SH level:</td>
                    <td class="w-3/5 text-left py-1">
                        <input id="viewSphericalHarmonicsDegree" type="text" class="border border-gray-400 bg-white p-1 rounded-md w-14" value="0">
                        <span class="text-gray-500 text-xs">(0-2)</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
  </div>

  <!-- Three.js Renderer Container -->
  <div id="renderer-container"></div>

  <script type="module">
    import * as GaussianSplats3D from 'gaussian-splats-3d';
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    let scene, camera, renderer, controls, dropInViewer;

    function initThree() {
        const container = document.getElementById('renderer-container');

        // Scene
        scene = new THREE.Scene();

        // Camera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 5); // Default position

        // Renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Controls
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Optional damping effect
        controls.target.set(0, 0, 0); // Set initial lookAt
        controls.update();

        // Basic Cube
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(-2, 0, 0); // Position it slightly
        scene.add(cube);

        // DropInViewer
        dropInViewer = new GaussianSplats3D.DropInViewer({
             'sharedMemoryForWorkers': false, // Match previous setting
             'gpuAcceleratedSort': false, // Recommended false if sharedMemory is false
             // Pass other relevant options from README if needed, e.g., sphericalHarmonicsDegree
             // Note: showLoadingUI is handled per-load via addSplatBuffers/addSplatScene
        });
        scene.add(dropInViewer); // Add viewer to the scene

        // Handle window resize
        window.addEventListener('resize', onWindowResize, false);

        // Start animation loop
        animate();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update(); // Update controls
        // dropInViewer.update() is called automatically via onBeforeRender callback
        renderer.render(scene, camera);
    }

    // Initialize Three.js setup on load
    initThree();

    // --- Splat Loading Logic ---

    // Simplified function assuming optimizeSplatData=false and compressionLevel=0 for direct viewing
    function fileBufferToSplatBuffer(fileBufferData, format, alphaRemovalThreshold, outSphericalHarmonicsDegree = 0) {
      // Disable optimization and compression for faster direct viewing
      const optimize = false;
      const compressionLevel = 0;
      if (format === GaussianSplats3D.SceneFormat.Ply) {
        return GaussianSplats3D.PlyLoader.loadFromFileData(fileBufferData.data, alphaRemovalThreshold, compressionLevel, optimize, outSphericalHarmonicsDegree, undefined, undefined, undefined, undefined);
      } else if (format === GaussianSplats3D.SceneFormat.Splat) {
        return GaussianSplats3D.SplatLoader.loadFromFileData(fileBufferData.data, alphaRemovalThreshold, compressionLevel, optimize, undefined, undefined, undefined, undefined);
      } else if (format === GaussianSplats3D.SceneFormat.KSplat) {
        return GaussianSplats3D.KSplatLoader.loadFromFileData(fileBufferData.data);
      } else {
        return Promise.reject(`Unsupported file format: ${format}`);
      }
    }

    // Assign functions to window object to make them accessible from inline HTML event handlers
    window.onFileChange = function(arg, fileNameLabelID) {
      const fileNameLabel = document.getElementById(fileNameLabelID);
      const viewFile = document.getElementById("viewFile");

      if (!arg || !arg.files || arg.files.length === 0) {
          fileNameLabel.innerHTML = '';
          return;
      }

      const url = arg.value;
      let lastForwardSlash = url.lastIndexOf('/');
      let lastBackwardSlash = url.lastIndexOf('\\');
      const lastSlash = Math.max(lastForwardSlash, lastBackwardSlash);
      fileNameLabel.innerHTML = url.substring(lastSlash + 1);

      const alphaRemovalThreshold = parseInt(document.getElementById("alphaRemovalThresholdView").value);
      let sphericalHarmonicsDegree = parseInt(document.getElementById("viewSphericalHarmonicsDegree").value);

      // Validation
      if (isNaN(alphaRemovalThreshold) || alphaRemovalThreshold < 0 || alphaRemovalThreshold > 255) {
        console.error("Invalid alpha removal threshold (0-255).");
        return;
      } else if (isNaN(sphericalHarmonicsDegree) || sphericalHarmonicsDegree < 0 || sphericalHarmonicsDegree > 2) {
        console.error("Invalid SH degree (0, 1, or 2).");
        return;
      }

      const viewFileName = viewFile.files[0].name.trim();
      const format = GaussianSplats3D.LoaderUtils.sceneFormatFromPath(viewFileName);

      if (format === undefined) {
          console.error("Could not determine file format. Ensure file has a .ply, .splat, or .ksplat extension.");
          return;
      }

      try {
        const fileReader = new FileReader();
        fileReader.onload = function(){
          console.log("Processing file...");
          setTimeout(() => { // Keep setTimeout for UI responsiveness during parse
              try {
                const splatBufferPromise = fileBufferToSplatBuffer({data: fileReader.result}, format, alphaRemovalThreshold, sphericalHarmonicsDegree);

                splatBufferPromise.then((splatBuffer) => {
                    // Dispose previous viewer resources first
                    dropInViewer.dispose().then(() => {
                        // Remove the old viewer from the scene
                        scene.remove(dropInViewer);

                        // Recreate DropInViewer to ensure clean state
                        dropInViewer = new GaussianSplats3D.DropInViewer({
                            'sharedMemoryForWorkers': false,
                            'gpuAcceleratedSort': false,
                            'sphericalHarmonicsDegree': sphericalHarmonicsDegree // Pass SH degree
                        });
                        scene.add(dropInViewer); // Add the new viewer to the scene

                        // Prepare options for adding the buffer
                        const splatBufferOptions = {
                            'splatAlphaRemovalThreshold': alphaRemovalThreshold,
                            // Add other per-scene options if needed, matching Viewer.addSplatBuffers expectations
                        };

                        // Access the internal viewer and use its addSplatBuffers method
                        // Arguments: splatBuffers[], splatBufferOptions[], finalBuild, showLoadingUIForSplatTreeBuild, replaceExisting, preserveVisibleRegion
                        dropInViewer.viewer.addSplatBuffers([splatBuffer], [splatBufferOptions], true, false, true, false)
                            .then(() => {
                                console.log("Splat buffer added via internal viewer.");
                                // Hide the initial UI panel
                                const uiContainer = document.getElementById("container");
                                if (uiContainer) uiContainer.style.display = 'none';
                            })
                            .catch((e) => {
                                console.error("Error adding splat buffer via internal viewer:", e);
                            });
                    });
                })
                .catch((e) => {
                    console.error("Error creating splat buffer:", e);
                });
              } catch (e) {
                console.error("Could not process scene: " + e.message);
              }
          }, 10);
        }
        fileReader.onerror = function() {
            console.error("Error reading file.");
        }
        console.log("Loading file...");
        fileReader.readAsArrayBuffer(viewFile.files[0]);
      } catch (e) {
        console.error("Could not load scene: " + e.message);
      }
    }

    // Removed runViewer function

  </script>
</body>
</html>
